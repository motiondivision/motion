<html>
    <head>
        <style>
            body {
                padding: 0;
                margin: 0;
            }

            #box {
                width: 100px;
                height: 100px;
                background-color: #00cc88;
            }

            #box.expanded {
                width: 200px;
                height: 200px;
                position: absolute;
                top: 50px;
                left: 50px;
            }

            [data-layout-correct="false"] {
                background: #dd1144 !important;
                opacity: 0.5;
            }
        </style>
    </head>
    <body>
        <!-- Box has data-layout so it participates in layout animation -->
        <div id="box" data-layout data-layout-correct="true"></div>

        <script type="module" src="/src/imports/animate-layout.js"></script>
        <script type="module" src="/src/imports/script-assert.js"></script>
        <script type="module">
            console.log("Test: single-element.html")

            const { unstable_animateLayout } = window.AnimateLayout
            const { matchViewportBox } = window.Assert
            const box = document.getElementById("box")

            console.log("unstable_animateLayout:", typeof unstable_animateLayout)

            if (!unstable_animateLayout) {
                showError(box, "unstable_animateLayout is not defined")
                throw new Error("unstable_animateLayout is not defined")
            }

            const boxOrigin = box.getBoundingClientRect()
            console.log("Box origin:", boxOrigin)

            ;(async () => {
                try {
                    const controls = await unstable_animateLayout(
                        box,
                        () => {
                            console.log("Mutation: adding expanded class")
                            box.classList.add("expanded")
                        },
                        { duration: 0.5 }
                    )

                    console.log("Controls:", controls)

                    // Check playback controls exist
                    if (typeof controls.pause !== "function") {
                        showError(box, "controls.pause is not a function")
                    }
                    if (typeof controls.play !== "function") {
                        showError(box, "controls.play is not a function")
                    }
                    if (typeof controls.stop !== "function") {
                        showError(box, "controls.stop is not a function")
                    }

                    // Wait for animation to finish before checking position
                    controls.finished.then(() => {
                        console.log("Animation finished")
                        const boxFinal = box.getBoundingClientRect()
                        console.log("Box final:", boxFinal)

                        matchViewportBox(box, {
                            top: 50,
                            left: 50,
                            right: 250,
                            bottom: 250,
                        })
                        console.log("Test passed!")
                    }).catch(err => {
                        console.error("Animation error:", err)
                        showError(box, `Animation error: ${err.message}`)
                    })
                } catch (err) {
                    console.error("Error:", err)
                    showError(box, `Error: ${err.message}`)
                }
            })()
        </script>
    </body>
</html>
