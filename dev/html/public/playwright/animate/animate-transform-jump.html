<html>
    <head>
        <style>
            body {
                margin: 0;
                padding: 40px;
                font-family: sans-serif;
            }

            .boxes {
                display: flex;
                gap: 20px;
            }

            .box {
                width: 60px;
                height: 60px;
                background-color: #0077ff;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
            }

            #indicator {
                width: 24px;
                height: 24px;
                background-color: #ff4444;
                border-radius: 50%;
                position: fixed;
                top: 10px;
                left: 40px;
                pointer-events: none;
            }

            #result {
                position: fixed;
                bottom: 10px;
                right: 10px;
                padding: 10px;
                background: #f0f0f0;
            }

            #debug {
                position: fixed;
                bottom: 50px;
                right: 10px;
                padding: 10px;
                background: #fff;
                font-size: 12px;
                max-width: 200px;
            }
        </style>
    </head>
    <body>
        <div class="boxes">
            <div class="box" data-index="0">0</div>
            <div class="box" data-index="1">1</div>
            <div class="box" data-index="2">2</div>
            <div class="box" data-index="3">3</div>
            <div class="box" data-index="4">4</div>
            <div class="box" data-index="5">5</div>
            <div class="box" data-index="6">6</div>
            <div class="box" data-index="7">7</div>
            <div class="box" data-index="8">8</div>
            <div class="box" data-index="9">9</div>
        </div>
        <div id="indicator"></div>
        <div id="result">ready</div>
        <div id="debug"></div>
        <script type="module" src="/src/inc.js"></script>
        <script type="module">
            const { animate, frame } = window.Motion

            const indicator = document.getElementById("indicator")
            const result = document.getElementById("result")
            const debug = document.getElementById("debug")
            const boxes = document.querySelectorAll(".box")

            /**
             * This test reproduces the transform jump bug in NativeAnimationExtended.
             *
             * Setup: A row of circles with a floating indicator that moves above
             * the hovered circle (like the tamagui.dev navigation).
             *
             * The bug: When rapidly moving between circles under CPU load,
             * the indicator "jumps" instead of smoothly animating.
             *
             * Test uses real mouseenter events triggered via dispatchEvent.
             */

            const positions = []
            let hoverCount = 0
            let maxJump = 0
            let jumpDetected = false

            function recordPosition(label) {
                const rect = indicator.getBoundingClientRect()
                const pos = {
                    label,
                    x: rect.x,
                    time: performance.now(),
                }
                positions.push(pos)

                if (positions.length >= 2) {
                    const prev = positions[positions.length - 2]
                    const jumpSize = Math.abs(pos.x - prev.x)
                    if (jumpSize > maxJump) {
                        maxJump = jumpSize
                    }
                    if (jumpSize > 80) {
                        jumpDetected = true
                    }
                }
            }

            function moveIndicatorToBox(box) {
                const rect = box.getBoundingClientRect()
                const targetX = rect.left + rect.width / 2 - 12

                hoverCount++
                recordPosition(`hover-${hoverCount}-before`)

                animate(
                    indicator,
                    { transform: `translateX(${targetX}px)` },
                    {
                        type: "spring",
                        stiffness: 200,
                        damping: 20,
                    }
                )

                recordPosition(`hover-${hoverCount}-after`)
            }

            // Block main thread to simulate CPU load
            function blockMainThread(ms) {
                const start = performance.now()
                while (performance.now() - start < ms) {
                    Math.random() * Math.random()
                }
            }

            // Add hover listeners to each box
            boxes.forEach((box) => {
                box.addEventListener("mouseenter", () => {
                    blockMainThread(8)
                    moveIndicatorToBox(box)
                })
            })

            // Expose function for Playwright to trigger rapid hovers
            // This triggers all hovers in rapid succession within each animation frame
            window.simulateRapidHovers = () => {
                const sequence = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 5, 0]
                let index = 0

                function triggerBatch() {
                    // Trigger a few hovers per frame with CPU blocking
                    for (let i = 0; i < 3 && index < sequence.length; i++) {
                        blockMainThread(8)
                        const box = boxes[sequence[index]]
                        box.dispatchEvent(new MouseEvent("mouseenter", {
                            bubbles: true,
                            cancelable: true,
                            view: window
                        }))
                        index++
                    }

                    if (index < sequence.length) {
                        requestAnimationFrame(triggerBatch)
                    } else {
                        // Done, check results after animations settle
                        setTimeout(() => {
                            if (jumpDetected) {
                                result.innerText = `jump:${Math.round(maxJump)}`
                            } else {
                                result.innerText = `smooth:${Math.round(maxJump)}`
                            }
                            indicator.dataset.maxJump = Math.round(maxJump)
                            debug.innerText = `Hovers: ${hoverCount}, Max: ${Math.round(maxJump)}px`
                        }, 200)
                    }
                }

                triggerBatch()
            }

            // Track positions each frame
            function trackFrame() {
                if (hoverCount > 0) {
                    recordPosition(`frame-${positions.length}`)
                }
                frame.postRender(trackFrame)
            }
            frame.postRender(trackFrame)
        </script>
    </body>
</html>
