<html>
    <head>
        <style>
            body {
                margin: 0;
            }

            #c {
                position: relative;
                width: 360px;
                height: 220px;
                background: #f0f0f0;
                overflow: hidden;
            }

            #slot {
                position: absolute;
                top: 8px;
                right: 8px;
            }

            #view {
                position: absolute;
                inset: 0;
            }

            .src {
                width: 64px;
                height: 20px;
                border-radius: 999px;
                background: #09f;
            }

            .dst {
                position: absolute;
                top: 56px;
                left: 112px;
                width: 160px;
                height: 84px;
                border-radius: 12px;
                background: #0b9;
            }

            [data-layout-correct="false"] {
                background: #dd1144 !important;
                opacity: 0.5;
            }
        </style>
    </head>
    <body>
        <div id="c">
            <div id="slot"></div>
            <div id="noise-a" hidden></div>
            <div id="noise-b" hidden></div>
            <div id="view"></div>
        </div>

        <script type="module" src="/src/imports/animate-layout.js"></script>
        <script type="module">
            const { animateLayout, frame } = window.AnimateLayout

            const c = document.getElementById("c")
            const slot = document.getElementById("slot")
            const noiseA = document.getElementById("noise-a")
            const noiseB = document.getElementById("noise-b")
            const view = document.getElementById("view")

            const source = '<div class="src" data-layout-id="shared"></div>'
            const target = '<div class="dst" data-layout-id="shared"></div>'
            const noiseSourceA = '<span data-layout-id="route-a"></span>'
            const noiseSourceB = '<span data-layout-id="route-b"></span>'
            const runs = 5

            const nextFrame = () =>
                new Promise((resolve) => frame.postRender(resolve))

            const maxDelta = (a, b) =>
                Math.max(
                    Math.abs(a.top - b.top),
                    Math.abs(a.left - b.left),
                    Math.abs(a.width - b.width),
                    Math.abs(a.height - b.height)
                )

            const fail = (message) => {
                c.dataset.layoutCorrect = "false"
                document.body.dataset.error = message
                throw new Error(message)
            }

            function initialPage() {
                slot.innerHTML = source
                view.innerHTML = ""
            }

            function softwarePage() {
                view.innerHTML = target
                noiseA.innerHTML = noiseSourceA
                noiseB.innerHTML = noiseSourceB
            }

            async function assertTargetMount(label) {
                const node = view.firstElementChild
                const restingBox = node?.getBoundingClientRect()
                const controls = await animateLayout(() => {}, {})
                const animations = Array.isArray(controls.animations)
                    ? controls.animations.length
                    : 0

                if (!(node instanceof HTMLElement) || !restingBox) {
                    fail(`${label} navigation invalid: missing target`)
                }
                if (animations <= 0) {
                    fail(`${label} navigation invalid: no animations`)
                }

                let displacement = 0
                for (let i = 0; i < 10; i++) {
                    await nextFrame()
                    displacement = Math.max(
                        displacement,
                        maxDelta(node.getBoundingClientRect(), restingBox)
                    )
                }

                if (displacement <= 1) {
                    fail(`${label} navigation invalid: no geometric movement`)
                }
            }

            async function runTest() {
                initialPage()

                for (let i = 0; i < runs; i++) {
                    softwarePage()
                    const mountTask = assertTargetMount(`Run ${i + 1}`)
                    await nextFrame()
                    slot.innerHTML = ""
                    await mountTask

                    initialPage()
                }
            }

            runTest().catch(console.error)
        </script>
    </body>
</html>
