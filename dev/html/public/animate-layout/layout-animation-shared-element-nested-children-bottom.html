<html>
    <head>
        <style>
            body {
                padding: 0;
                margin: 0;
            }

            .card {
                width: 300px;
                border-radius: 16px;
                overflow: hidden;
                background-color: #222;
                color: #fff;
            }

            .card .image-container {
                overflow: hidden;
                height: 160px;
                position: relative;
            }

            .card .image {
                height: 200px;
                background: #333;
                position: absolute;
                top: -20px;
                left: 0;
                right: 0;
            }

            .card .title-container {
                padding: 12px;
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .card .title-container h2 {
                font-size: 16px;
                margin: 0;
            }

            .card .title-container span {
                font-size: 11px;
                text-transform: uppercase;
            }

            .modal-wrapper {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 40px;
            }

            .modal-wrapper .card {
                width: 500px;
            }

            .modal-wrapper .image-container {
                height: 220px;
            }

            .modal-wrapper .image {
                height: 260px;
                top: -20px;
            }

            .modal-wrapper .title-container {
                padding: 20px;
            }

            .modal-wrapper .title-container h2 {
                font-size: 22px;
            }

            .modal-wrapper .title-container span {
                font-size: 12px;
            }

            [data-layout-correct="false"] {
                background: #dd1144 !important;
                opacity: 0.5;
            }
        </style>
    </head>
    <body>
        <div class="card" id="card-content" data-layout-id="card-content">
            <div
                class="image-container"
                id="image-container"
                data-layout-id="image-container"
                data-layout="position"
            >
                <div
                    class="image"
                    id="image"
                    data-layout-id="image"
                    data-layout="preserve-aspect"
                ></div>
            </div>
            <div
                class="title-container"
                id="title-container"
                data-layout-id="title-container"
                data-layout="position"
            >
                <span>Hats</span>
                <h2>Take Control of Your Hat Life</h2>
            </div>
        </div>

        <script type="module" src="/src/imports/animate-layout.js"></script>
        <script type="module" src="/src/imports/script-assert.js"></script>
        <script type="module">
            const { runLayoutAnimation, frame } = window.AnimateLayout
            const { matchViewportBox, matchOpacity } = window.Assert

            // Get initial element references
            const cardContent = document.getElementById("card-content")
            const imageContainer = document.getElementById("image-container")
            const image = document.getElementById("image")
            const titleContainer = document.getElementById("title-container")

            // Capture initial positions
            const initialCardContentBox = cardContent.getBoundingClientRect()
            const initialImageContainerBox = imageContainer.getBoundingClientRect()
            const initialImageBox = image.getBoundingClientRect()
            const initialTitleBox = titleContainer.getBoundingClientRect()

            console.log("Initial positions:")
            console.log(
                "  card-content:",
                JSON.stringify({
                    top: initialCardContentBox.top,
                    left: initialCardContentBox.left,
                    width: initialCardContentBox.width,
                    height: initialCardContentBox.height,
                })
            )
            console.log(
                "  image-container:",
                JSON.stringify({
                    top: initialImageContainerBox.top,
                    left: initialImageContainerBox.left,
                    width: initialImageContainerBox.width,
                    height: initialImageContainerBox.height,
                })
            )
            console.log(
                "  image:",
                JSON.stringify({
                    top: initialImageBox.top,
                    left: initialImageBox.left,
                    width: initialImageBox.width,
                    height: initialImageBox.height,
                })
            )
            console.log(
                "  title-container:",
                JSON.stringify({
                    top: initialTitleBox.top,
                    left: initialTitleBox.left,
                    width: initialTitleBox.width,
                    height: initialTitleBox.height,
                })
            )

            // First, create modal WITHOUT animateLayout to measure final positions
            function createModal() {
                const modalWrapper = document.createElement("div")
                modalWrapper.className = "modal-wrapper"
                modalWrapper.id = "modal-wrapper"

                const clonedContent = cardContent.cloneNode(true)
                clonedContent.id = "modal-content"

                const clonedImageContainer = clonedContent.querySelector(
                    ".image-container"
                )
                const clonedImage = clonedContent.querySelector(".image")
                const clonedTitleContainer =
                    clonedContent.querySelector(".title-container")
                clonedImageContainer.id = "modal-image-container"
                clonedImage.id = "modal-image"
                clonedTitleContainer.id = "modal-title-container"

                modalWrapper.appendChild(clonedContent)
                document.body.appendChild(modalWrapper)
            }

            function removeModal() {
                const modalWrapper = document.getElementById("modal-wrapper")
                if (modalWrapper) modalWrapper.remove()
            }

            // Measure final positions
            createModal()
            const finalCardContentBox = document
                .getElementById("modal-content")
                .getBoundingClientRect()
            const finalImageContainerBox = document
                .getElementById("modal-image-container")
                .getBoundingClientRect()
            const finalImageBox = document
                .getElementById("modal-image")
                .getBoundingClientRect()
            const finalTitleBox = document
                .getElementById("modal-title-container")
                .getBoundingClientRect()
            removeModal()

            console.log("Final (modal) positions:")
            console.log(
                "  card-content:",
                JSON.stringify({
                    top: finalCardContentBox.top,
                    left: finalCardContentBox.left,
                    width: finalCardContentBox.width,
                    height: finalCardContentBox.height,
                })
            )
            console.log(
                "  image-container:",
                JSON.stringify({
                    top: finalImageContainerBox.top,
                    left: finalImageContainerBox.left,
                    width: finalImageContainerBox.width,
                    height: finalImageContainerBox.height,
                })
            )
            console.log(
                "  image:",
                JSON.stringify({
                    top: finalImageBox.top,
                    left: finalImageBox.left,
                    width: finalImageBox.width,
                    height: finalImageBox.height,
                })
            )
            console.log(
                "  title-container:",
                JSON.stringify({
                    top: finalTitleBox.top,
                    left: finalTitleBox.left,
                    width: finalTitleBox.width,
                    height: finalTitleBox.height,
                })
            )

            async function runTest() {
                // === OPEN ANIMATION ===
                console.log("=== OPEN ANIMATION ===")

                const openControls = await runLayoutAnimation(
                    document.body,
                    () => {
                        createModal()
                    },
                    { duration: 1, ease: "linear" }
                )

                openControls.pause()

                // Get modal element references
                const modalContent = document.getElementById("modal-content")
                const modalImageContainer = document.getElementById(
                    "modal-image-container"
                )
                const modalImage = document.getElementById("modal-image")
                const modalTitleContainer = document.getElementById(
                    "modal-title-container"
                )

                // Check at t=0.5 (midpoint)
                openControls.time = 0.5
                await new Promise((resolve) => frame.postRender(resolve))

                console.log("At time 0.5 (midpoint):")

                // Calculate expected midpoint positions (linear interpolation)
                const midCardContent = {
                    top: (initialCardContentBox.top + finalCardContentBox.top) / 2,
                    left:
                        (initialCardContentBox.left + finalCardContentBox.left) /
                        2,
                    right:
                        (initialCardContentBox.right +
                            finalCardContentBox.right) /
                        2,
                    bottom:
                        (initialCardContentBox.bottom +
                            finalCardContentBox.bottom) /
                        2,
                }

                const midImageContainer = {
                    top:
                        (initialImageContainerBox.top +
                            finalImageContainerBox.top) /
                        2,
                    left:
                        (initialImageContainerBox.left +
                            finalImageContainerBox.left) /
                        2,
                    right:
                        (initialImageContainerBox.right +
                            finalImageContainerBox.right) /
                        2,
                    bottom:
                        (initialImageContainerBox.bottom +
                            finalImageContainerBox.bottom) /
                        2,
                }

                const midImage = {
                    top: (initialImageBox.top + finalImageBox.top) / 2,
                    left: (initialImageBox.left + finalImageBox.left) / 2,
                    right: (initialImageBox.right + finalImageBox.right) / 2,
                    bottom: (initialImageBox.bottom + finalImageBox.bottom) / 2,
                }

                // For title-container with data-layout="position", only position should interpolate
                // Size should remain at final size
                const midTitle = {
                    top: (initialTitleBox.top + finalTitleBox.top) / 2,
                    left: (initialTitleBox.left + finalTitleBox.left) / 2,
                    right:
                        (initialTitleBox.left + finalTitleBox.left) / 2 +
                        finalTitleBox.width,
                    bottom:
                        (initialTitleBox.top + finalTitleBox.top) / 2 +
                        finalTitleBox.height,
                }

                // Check modal elements are at midpoint
                const actualModalContent = modalContent.getBoundingClientRect()
                const actualModalImageContainer =
                    modalImageContainer.getBoundingClientRect()
                const actualModalImage = modalImage.getBoundingClientRect()
                const actualModalTitle = modalTitleContainer.getBoundingClientRect()

                console.log(
                    "  Expected card-content:",
                    JSON.stringify(midCardContent)
                )
                console.log(
                    "  Actual card-content:",
                    JSON.stringify({
                        top: actualModalContent.top,
                        left: actualModalContent.left,
                        right: actualModalContent.right,
                        bottom: actualModalContent.bottom,
                    })
                )

                console.log(
                    "  Expected image-container:",
                    JSON.stringify(midImageContainer)
                )
                console.log(
                    "  Actual image-container:",
                    JSON.stringify({
                        top: actualModalImageContainer.top,
                        left: actualModalImageContainer.left,
                        right: actualModalImageContainer.right,
                        bottom: actualModalImageContainer.bottom,
                    })
                )

                console.log("  Expected image:", JSON.stringify(midImage))
                console.log(
                    "  Actual image:",
                    JSON.stringify({
                        top: actualModalImage.top,
                        left: actualModalImage.left,
                        right: actualModalImage.right,
                        bottom: actualModalImage.bottom,
                    })
                )

                console.log(
                    "  Expected title (position only):",
                    JSON.stringify(midTitle)
                )
                console.log(
                    "  Actual title:",
                    JSON.stringify({
                        top: actualModalTitle.top,
                        left: actualModalTitle.left,
                        right: actualModalTitle.right,
                        bottom: actualModalTitle.bottom,
                    })
                )

                matchViewportBox(modalContent, midCardContent)
                matchViewportBox(modalImageContainer, midImageContainer)
                matchViewportBox(modalImage, midImage)
                matchViewportBox(modalTitleContainer, midTitle)

                // === CLOSE ANIMATION ===
                console.log("=== CLOSE ANIMATION ===")

                const closeControls = await runLayoutAnimation(
                    document.body,
                    () => {
                        removeModal()
                    },
                    { duration: 1, ease: "linear" }
                )

                closeControls.pause()
                closeControls.time = 0.5

                await new Promise((resolve) => frame.postRender(resolve))

                // Card content should be halfway between modal and card positions
                const expectedCardContentBox = {
                    top:
                        (initialCardContentBox.top + finalCardContentBox.top) /
                        2,
                    left:
                        (initialCardContentBox.left +
                            finalCardContentBox.left) /
                        2,
                    right:
                        (initialCardContentBox.right +
                            finalCardContentBox.right) /
                        2,
                    bottom:
                        (initialCardContentBox.bottom +
                            finalCardContentBox.bottom) /
                        2,
                }

                const expectedImageContainerBox = {
                    top:
                        (initialImageContainerBox.top +
                            finalImageContainerBox.top) /
                        2,
                    left:
                        (initialImageContainerBox.left +
                            finalImageContainerBox.left) /
                        2,
                    right:
                        (initialImageContainerBox.right +
                            finalImageContainerBox.right) /
                        2,
                    bottom:
                        (initialImageContainerBox.bottom +
                            finalImageContainerBox.bottom) /
                        2,
                }

                const expectedImageBox = {
                    top: (initialImageBox.top + finalImageBox.top) / 2,
                    left: (initialImageBox.left + finalImageBox.left) / 2,
                    right: (initialImageBox.right + finalImageBox.right) / 2,
                    bottom: (initialImageBox.bottom + finalImageBox.bottom) / 2,
                }

                const expectedTitleBox = {
                    top: (initialTitleBox.top + finalTitleBox.top) / 2,
                    left: (initialTitleBox.left + finalTitleBox.left) / 2,
                    right:
                        (initialTitleBox.left + finalTitleBox.left) / 2 +
                        finalTitleBox.width,
                    bottom:
                        (initialTitleBox.top + finalTitleBox.top) / 2 +
                        finalTitleBox.height,
                }

                // Make sure we're animating the correct elements
                matchViewportBox(cardContent, expectedCardContentBox)
                matchViewportBox(imageContainer, expectedImageContainerBox)
                matchViewportBox(image, expectedImageBox)
                matchViewportBox(titleContainer, expectedTitleBox)

                // Ensure that opacity isn't crossfading
                matchOpacity(cardContent, 1)
                matchOpacity(imageContainer, 1)
                matchOpacity(image, 1)
                matchOpacity(titleContainer, 1)
            }

            runTest().catch(console.error)
        </script>
    </body>
</html>
