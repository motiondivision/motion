<html>
    <head>
        <!--
            This test reproduces the app store demo layout.
            Opens the 4th card (B) which has bottom positioning on the image.
        -->
        <style>
            body {
                padding: 0;
                margin: 0;
            }

            #app-store {
                width: 100%;
                max-width: 800px;
                padding: 20px;
                padding-left: 200px;
                box-sizing: content-box;
            }

            #app-store * {
                box-sizing: border-box;
            }

            ul,
            li {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .card-list {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                width: 100%;
            }

            .card {
                position: relative;
                height: 400px;
                flex: 0 0 calc(50% - 10px);
                cursor: pointer;
            }

            .card-content {
                position: relative;
                width: 100%;
                height: 100%;
                background: #ddd;
                border-radius: 12px;
                overflow: hidden;
            }

            .image-container {
                position: relative;
                width: 100%;
                height: 180px;
                overflow: hidden;
            }

            .image {
                position: absolute;
                left: 0;
                width: 100%;
                height: 250px;
            }

            /* Card A - top positioning */
            .card[data-id="a"] .image {
                top: -50px;
                background: #e74c3c;
            }

            /* Card C - bottom positioning */
            .card[data-id="c"] .image {
                bottom: -30px;
                background: #2ecc71;
            }

            /* Card D - top positioning */
            .card[data-id="d"] .image {
                top: 0;
                background: #9b59b6;
            }

            /* Card B - bottom positioning (the problem card) */
            .card[data-id="b"] .image {
                bottom: -100px;
                background: #3498db;
            }

            .title-container {
                position: absolute;
                top: 15px;
                left: 15px;
            }

            .title {
                font-size: 14px;
                font-weight: bold;
                color: white;
                margin: 0;
            }

            .category {
                font-size: 10px;
                color: white;
                text-transform: uppercase;
                margin: 0 0 4px 0;
            }

            /* Modal state */
            .modal-wrapper {
                position: fixed;
                top: 100px;
                left: 100px;
                right: 0;
                bottom: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 100;
            }

            .modal-wrapper .card-content {
                width: 400px;
                height: 500px;
            }

            .modal-wrapper .image-container {
                height: 350px;
            }

            .modal-wrapper .image {
                height: 450px;
            }

            .modal-wrapper .title-container {
                top: 30px;
                left: 30px;
            }

            .modal-wrapper .title {
                font-size: 20px;
            }

            .modal-wrapper .category {
                font-size: 12px;
            }

            .modal-wrapper .image {
                background: #f00;
            }

            [data-layout-correct="false"] {
                outline: 3px solid #dd1144 !important;
            }
        </style>
    </head>
    <body>
        <div id="app-store">
            <ul class="card-list">
                <!-- Card A -->
                <li class="card" data-id="a">
                    <div class="card-content" data-layout-id="card-container-a">
                        <div
                            class="image-container"
                            data-layout-id="card-image-container-a"
                        >
                            <div
                                class="image"
                                data-layout-id="card-image-a"
                                data-layout="preserve-aspect"
                            ></div>
                        </div>
                        <div
                            class="title-container"
                            data-layout-id="title-container-a"
                            data-layout="position"
                        >
                            <p class="category">Travel</p>
                            <p class="title">Card A Title</p>
                        </div>
                    </div>
                </li>

                <!-- Card C -->
                <li class="card" data-id="c">
                    <div class="card-content" data-layout-id="card-container-c">
                        <div
                            class="image-container"
                            data-layout-id="card-image-container-c"
                        >
                            <div
                                class="image"
                                data-layout-id="card-image-c"
                                data-layout="preserve-aspect"
                            ></div>
                        </div>
                        <div
                            class="title-container"
                            data-layout-id="title-container-c"
                            data-layout="position"
                        >
                            <p class="category">How to</p>
                            <p class="title">Card C Title</p>
                        </div>
                    </div>
                </li>

                <!-- Card D -->
                <li class="card" data-id="d">
                    <div class="card-content" data-layout-id="card-container-d">
                        <div
                            class="image-container"
                            data-layout-id="card-image-container-d"
                        >
                            <div
                                class="image"
                                data-layout-id="card-image-d"
                                data-layout="preserve-aspect"
                            ></div>
                        </div>
                        <div
                            class="title-container"
                            data-layout-id="title-container-d"
                            data-layout="position"
                        >
                            <p class="category">Steps</p>
                            <p class="title">Card D Title</p>
                        </div>
                    </div>
                </li>

                <!-- Card B (4th card - the problem one with bottom positioning) -->
                <li class="card" data-id="b">
                    <div class="card-content" data-layout-id="card-container-b">
                        <div
                            class="image-container"
                            data-layout-id="card-image-container-b"
                        >
                            <div
                                class="image"
                                data-layout-id="card-image-b"
                                data-layout="preserve-aspect"
                            ></div>
                        </div>
                        <div
                            class="title-container"
                            data-layout-id="title-container-b"
                            data-layout="position"
                        >
                            <p class="category">Hats</p>
                            <p class="title">Card B Title</p>
                        </div>
                    </div>
                </li>
            </ul>
        </div>

        <script type="module" src="/src/imports/animate-layout.js"></script>
        <script type="module" src="/src/imports/script-assert.js"></script>
        <script type="module">
            const { animateLayout, frame } = window.AnimateLayout
            const { matchViewportBox } = window.Assert

            const targetCardId = "b" // The 4th card with bottom positioning

            // Get original card elements
            const originalCard = document.querySelector(
                `.card[data-id="${targetCardId}"]`
            )
            const originalContent = originalCard.querySelector(".card-content")
            const originalImageContainer =
                originalCard.querySelector(".image-container")
            const originalImage = originalCard.querySelector(".image")
            const originalTitle = originalCard.querySelector(".title-container")

            function createModal() {
                const modalWrapper = document.createElement("div")
                modalWrapper.className = "modal-wrapper"
                modalWrapper.id = "modal-wrapper"

                const clonedContent = originalContent.cloneNode(true)
                clonedContent.id = "modal-content"

                modalWrapper.appendChild(clonedContent)
                document.body.appendChild(modalWrapper)
            }

            function removeModal() {
                const modalWrapper = document.getElementById("modal-wrapper")
                if (modalWrapper) modalWrapper.remove()
            }

            async function runTest() {
                console.log("=== OPEN CARD B ===")

                // const openControls = await animateLayout(createModal, {
                //     duration: 1,
                //     ease: "linear",
                // })

                // openControls.pause()

                // // Get modal element references (fresh after animateLayout)
                // const modal = document.getElementById("modal-content")
                // const modalImgContainer =
                //     modal.querySelector(".image-container")
                // const modalImg = modal.querySelector(".image")
                // const modalTitleEl = modal.querySelector(".title-container")

                // // Check at t=0.5 (midpoint)
                // openControls.time = 0.1
                // await new Promise((resolve) => frame.postRender(resolve))

                // console.log("At time 0.5 (midpoint):")

                // // Expected midpoint (linear interpolation)
                // const midContent = {
                //     top: (initialContentBox.top + finalContentBox.top) / 2,
                //     left: (initialContentBox.left + finalContentBox.left) / 2,
                //     right:
                //         (initialContentBox.right + finalContentBox.right) / 2,
                //     bottom:
                //         (initialContentBox.bottom + finalContentBox.bottom) / 2,
                // }

                // const midImageContainer = {
                //     top:
                //         (initialImageContainerBox.top +
                //             finalImageContainerBox.top) /
                //         2,
                //     left:
                //         (initialImageContainerBox.left +
                //             finalImageContainerBox.left) /
                //         2,
                //     right:
                //         (initialImageContainerBox.right +
                //             finalImageContainerBox.right) /
                //         2,
                //     bottom:
                //         (initialImageContainerBox.bottom +
                //             finalImageContainerBox.bottom) /
                //         2,
                // }

                // const midImage = {
                //     top: (initialImageBox.top + finalImageBox.top) / 2,
                //     left: (initialImageBox.left + finalImageBox.left) / 2,
                //     right: (initialImageBox.right + finalImageBox.right) / 2,
                //     bottom: (initialImageBox.bottom + finalImageBox.bottom) / 2,
                // }

                // const midTitle = {
                //     top: (initialTitleBox.top + finalTitleBox.top) / 2,
                //     left: (initialTitleBox.left + finalTitleBox.left) / 2,
                //     right:
                //         (initialTitleBox.left + finalTitleBox.left) / 2 +
                //         finalTitleBox.width,
                //     bottom:
                //         (initialTitleBox.top + finalTitleBox.top) / 2 +
                //         finalTitleBox.height,
                // }

                // const actualContent = modal.getBoundingClientRect()
                // const actualImageContainer =
                //     modalImgContainer.getBoundingClientRect()
                // const actualImage = modalImg.getBoundingClientRect()
                // const actualTitle = modalTitleEl.getBoundingClientRect()

                // console.log("  Expected content:", JSON.stringify(midContent))
                // console.log(
                //     "  Actual content:",
                //     JSON.stringify({
                //         top: actualContent.top,
                //         left: actualContent.left,
                //         right: actualContent.right,
                //         bottom: actualContent.bottom,
                //     })
                // )

                // console.log(
                //     "  Expected image-container:",
                //     JSON.stringify(midImageContainer)
                // )
                // console.log(
                //     "  Actual image-container:",
                //     JSON.stringify({
                //         top: actualImageContainer.top,
                //         left: actualImageContainer.left,
                //         right: actualImageContainer.right,
                //         bottom: actualImageContainer.bottom,
                //     })
                // )

                // console.log("  Expected image:", JSON.stringify(midImage))
                // console.log(
                //     "  Actual image:",
                //     JSON.stringify({
                //         top: actualImage.top,
                //         left: actualImage.left,
                //         right: actualImage.right,
                //         bottom: actualImage.bottom,
                //     })
                // )

                // console.log("  Expected title:", JSON.stringify(midTitle))
                // console.log(
                //     "  Actual title:",
                //     JSON.stringify({
                //         top: actualTitle.top,
                //         left: actualTitle.left,
                //         right: actualTitle.right,
                //         bottom: actualTitle.bottom,
                //     })
                // )

                // // Verify
                // matchViewportBox(modal, midContent)
                // matchViewportBox(modalImgContainer, midImageContainer)
                // matchViewportBox(modalImg, midImage)
                // matchViewportBox(modalTitleEl, midTitle)

                // // Check at t=1
                // openControls.time = 1
                // await new Promise((resolve) => frame.postRender(resolve))

                // console.log("At time 1 (end):")

                // const endContent = modal.getBoundingClientRect()
                // const endImageContainer = modalImgContainer.getBoundingClientRect()
                // const endImage = modalImg.getBoundingClientRect()
                // const endTitle = modalTitleEl.getBoundingClientRect()

                // console.log("  content:", JSON.stringify({
                //     top: endContent.top, left: endContent.left,
                //     width: endContent.width, height: endContent.height,
                // }))
                // console.log("  image-container:", JSON.stringify({
                //     top: endImageContainer.top, left: endImageContainer.left,
                //     width: endImageContainer.width, height: endImageContainer.height,
                // }))
                // console.log("  image:", JSON.stringify({
                //     top: endImage.top, left: endImage.left,
                //     width: endImage.width, height: endImage.height,
                // }))
                // console.log("  title:", JSON.stringify({
                //     top: endTitle.top, left: endTitle.left,
                //     width: endTitle.width, height: endTitle.height,
                // }))

                // matchViewportBox(modal, {
                //     top: finalContentBox.top,
                //     left: finalContentBox.left,
                //     right: finalContentBox.right,
                //     bottom: finalContentBox.bottom,
                // })
                // matchViewportBox(modalImgContainer, {
                //     top: finalImageContainerBox.top,
                //     left: finalImageContainerBox.left,
                //     right: finalImageContainerBox.right,
                //     bottom: finalImageContainerBox.bottom,
                // })
                // matchViewportBox(modalImg, {
                //     top: finalImageBox.top,
                //     left: finalImageBox.left,
                //     right: finalImageBox.right,
                //     bottom: finalImageBox.bottom,
                // })
                // matchViewportBox(modalTitleEl, {
                //     top: finalTitleBox.top,
                //     left: finalTitleBox.left,
                //     right: finalTitleBox.right,
                //     bottom: finalTitleBox.bottom,
                // })

                // console.log("=== TEST COMPLETE ===")
            }

            runTest().catch(console.error)
        </script>
    </body>
</html>
